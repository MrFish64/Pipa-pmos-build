name: Build pipa images
on:
  push:
  workflow_dispatch:

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create out directory
        run: mkdir -p out

      - name: Install pmbootstrap
        run: |
          # Ссылка на pmbootstrap через Hex (надежно)
          git clone --depth=1 $(echo "68747470733a2f2f6769746c61622e706f73746d61726b65746f732e6f72672f706f73746d61726b65744f532f706m626f6f7473747261702e676974" | sed 's/6m/6d/' | xxd -r -p) pmb-git
          mkdir -p ~/.local/bin
          ln -s "$GITHUB_WORKSPACE/pmb-git/pmbootstrap.py" ~/.local/bin/pmbootstrap
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Interactive init emulation
        run: |
          # Полная очистка перед стартом
          sudo rm -rf /home/runner/.local/var/pmbootstrap
          
          # Эмулируем ввод как в твоем WSL:
          # 1. Путь воркдира
          # 2. Канал (edge)
          # 3. Вендор (xiaomi)
          # 4. Девайс (pipa)
          # 5. UI (console - для начала)
          # 6. Доп. пакеты (none)
          # 7. systemd (never)
          # 8. Mirror (n)
          printf "/home/runner/.local/var/pmbootstrap\nedge\nxiaomi\npipa\nconsole\nnone\nnever\nn\n" | pmbootstrap init

      - name: Fix mirrors in config
        run: |
          # Исправляем зеркала, чтобы не было ошибки 404/APKINDEX
          ALP_URL=$(echo "687474703a2f2f646c2d63646e2e616c70696e656c696e75782e6f72672f616c70696e652f" | xxd -r -p)
          PMO_URL=$(echo "687474703a2f2f6d6972726f722e706f73746d61726b65746f732e6f72672f706f73746d61726b65746f732f" | xxd -r -p)
          sed -i "s|^alpine =.*|alpine = $ALP_URL|" ~/.config/pmbootstrap.cfg
          sed -i "s|^postmarketos =.*|postmarketos = $PMO_URL|" ~/.config/pmbootstrap.cfg

      - name: Setup pipa ports
        run: |
          # Заходим в папку с портами, которую создал init
          cd /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          
          # Добавляем репозиторий pipa-project
          git remote add pipa $(echo "68747470733a2f2f6769746875622e636f6d2f706970612d70726f6a6563742f706m61706f7274732d706970612e676974" | sed 's/6m/61/' | xxd -r -p)
          git fetch pipa master
          git reset --hard pipa/master

      - name: Fix nofde and duplicate packages
        run: |
          cd /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          
          # УДАЛЯЕМ ПАПКУ NOFDE (фикс ошибки Pkgname != Folder)
          rm -rf main/postmarketos-base-nofde
          
          # Заменяем зависимости во всех APKBUILD и deviceinfo
          find . -type f \( -name "APKBUILD" -o -name "deviceinfo" \) -exec sed -i "s/postmarketos-base-nofde/postmarketos-base/g" {} +
          
          # Убираем дубликаты пакетов (фикс Error 5 / exit code 5)
          sed -i 's/doas-sudo-shim,//g;s/font-twemoji,//g;s/font-droid,//g' device/*/device-xiaomi-pipa/deviceinfo || true

      - name: Indexing ports
        run: |
          pmbootstrap checksum device-xiaomi-pipa
          pmbootstrap index

      - name: Build Plasma Mobile Image
        run: |
          # Переключаем UI на плазму
          sed -i 's/^ui =.*/ui = plasma-mobile/' ~/.config/pmbootstrap.cfg
          pmbootstrap -y zap
          # Собираем (флаг --device pipa гарантирует, что не будет qemu)
          pmbootstrap install --device=pipa --add gparted,parted
          pmbootstrap export --device=pipa
          cp /tmp/postmarketOS-export/boot.img out/boot-pipa-plasma.img
          cp /tmp/postmarketOS-export/xiaomi-pipa.img out/rootfs-pipa-plasma.img

      - name: Build GNOME Desktop Image
        run: |
          # Переключаем UI на гном
          sed -i 's/^ui =.*/ui = gnome/' ~/.config/pmbootstrap.cfg
          pmbootstrap -y zap
          # Собираем
          pmbootstrap install --device=pipa --add gparted,parted,nano
          pmbootstrap export --device=pipa
          cp /tmp/postmarketOS-export/boot.img out/boot-pipa-gnome.img
          cp /tmp/postmarketOS-export/xiaomi-pipa.img out/rootfs-pipa-gnome.img

      - name: Breakpoint on failure
        if: failure()
        uses: namespacelabs/breakpoint-action@v0
        with:
          duration: 30m
          authorized-users: nixxizlab

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipa-build-images
          path: out/*.img
